#!/bin/bash
# Smart Validation - Change-aware test selection for Papeterie Engine
# Runs only tests affected by code changes for faster feedback loops.
set -eo pipefail

# Store the project root directory
ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
cd "$ROOT_DIR"

# ============================================
# Configuration
# ============================================
MODE="default"        # default | changeset_only | full
INCLUDE_E2E=false
FORCE_REFRESH=false
VERBOSE=false

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ============================================
# Help
# ============================================
show_help() {
    cat <<EOF
${BLUE}Smart Validation${NC} - Change-aware test selection

${YELLOW}Usage:${NC} ./scripts/smart_validate.sh [options]

${YELLOW}Modes:${NC}
  (default)           Tests covering changed files (balanced)
  --changeset_only    Tests touching changed LOC only (fastest)
  --full              All tests (complete validation)

${YELLOW}Options:${NC}
  --e2e               Include E2E tests (skipped by default, slow)
  --refresh           Force refresh of testmon/LOC databases
  --verbose           Show detailed test output
  --help              Show this help

${YELLOW}Examples:${NC}
  ./scripts/smart_validate.sh                    # Standard smart run
  ./scripts/smart_validate.sh --changeset_only   # LOC-only (fastest)
  ./scripts/smart_validate.sh --full --e2e       # Complete validation

${YELLOW}Notes:${NC}
  - E2E tests are skipped by default as they don't provide LOC coverage
  - First run may be slower as it builds the test dependency database
  - Use --full for CI/pre-merge validation
EOF
}

# ============================================
# Argument Parsing
# ============================================
for arg in "$@"; do
    case $arg in
        --help|-h)
            show_help
            exit 0
            ;;
        --changeset_only)
            MODE="changeset_only"
            ;;
        --full)
            MODE="full"
            ;;
        --e2e)
            INCLUDE_E2E=true
            ;;
        --refresh)
            FORCE_REFRESH=true
            ;;
        --verbose|-v)
            VERBOSE=true
            ;;
        *)
            echo -e "${RED}Unknown option: $arg${NC}"
            show_help
            exit 1
            ;;
    esac
done

# ============================================
# Setup
# ============================================
mkdir -p logs
LOG_FILE="logs/smart_validate.log"

# Timing
TOTAL_START=$(date +%s)
BACKEND_DURATION=0
FRONTEND_DURATION=0
E2E_DURATION=0

# Results
BACKEND_PASSED=0
BACKEND_FAILED=0
BACKEND_SKIPPED=0
BACKEND_DESELECTED=0
FRONTEND_PASSED=0
FRONTEND_FAILED=0

echo -e "${BLUE}Smart Validation${NC} starting at $(date)" | tee "$LOG_FILE"
echo "Mode: $MODE" | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"

# ============================================
# Testmon Database Refresh
# ============================================
refresh_testmon_if_needed() {
    if [ "$FORCE_REFRESH" = true ]; then
        echo -e "${YELLOW}Forcing testmon database refresh...${NC}" | tee -a "$LOG_FILE"
        uv run pytest --testmon --collect-only -q 2>&1 | tee -a "$LOG_FILE"
        return
    fi
    
    # Check if any test files have changed since last run
    if [ -f ".testmondata" ]; then
        local testmon_mtime=$(stat -c %Y .testmondata 2>/dev/null || echo 0)
        local test_changes=$(find tests/ -name "*.py" -newer .testmondata 2>/dev/null | wc -l)
        
        if [ "$test_changes" -gt 0 ]; then
            echo -e "${YELLOW}New test files detected, refreshing testmon database...${NC}" | tee -a "$LOG_FILE"
            uv run pytest --testmon --collect-only -q 2>&1 | tee -a "$LOG_FILE"
        fi
    fi
}

# ============================================
# Backend Tests (Python)
# ============================================
run_backend_tests() {
    echo -e "${BLUE}=== Backend Tests (Python) ===${NC}" | tee -a "$LOG_FILE"
    local start=$(date +%s)
    
    local pytest_args=""
    
    case "$MODE" in
        changeset_only)
            # LOC-only: testmon's default, with forceselect to work with markers
            echo "Selection: Tests touching changed lines only" | tee -a "$LOG_FILE"
            pytest_args="--testmon --testmon-forceselect -m \"not live\""
            ;;
        full)
            # All tests, no testmon selection
            echo "Selection: All tests" | tee -a "$LOG_FILE"
            pytest_args="-m \"not live\""
            ;;
        *)
            # Default: testmon with file-level coverage
            echo "Selection: Tests covering changed files" | tee -a "$LOG_FILE"
            pytest_args="--testmon --testmon-forceselect -m \"not live\""
            ;;
    esac
    
    # Add quiet mode unless verbose
    if [ "$VERBOSE" = false ]; then
        pytest_args="$pytest_args -q"
    fi
    
    # Run tests and capture output
    local output
    output=$(eval "uv run pytest $pytest_args 2>&1") || true
    echo "$output" | tee -a "$LOG_FILE"
    
    # Parse results
    BACKEND_PASSED=$(echo "$output" | grep -oP '\d+(?= passed)' | tail -1 || echo 0)
    BACKEND_FAILED=$(echo "$output" | grep -oP '\d+(?= failed)' | tail -1 || echo 0)
    BACKEND_SKIPPED=$(echo "$output" | grep -oP '\d+(?= skipped)' | tail -1 || echo 0)
    BACKEND_DESELECTED=$(echo "$output" | grep -oP '\d+(?= deselected)' | tail -1 || echo 0)
    
    local end=$(date +%s)
    BACKEND_DURATION=$((end - start))
    echo "TIMING: Backend=${BACKEND_DURATION}s" >> "$LOG_FILE"
}

# ============================================
# Frontend Tests (Vitest)
# ============================================
run_frontend_tests() {
    echo "" | tee -a "$LOG_FILE"
    echo -e "${BLUE}=== Frontend Tests (Vitest) ===${NC}" | tee -a "$LOG_FILE"
    local start=$(date +%s)
    
    cd src/web
    
    local vitest_args=""
    
    case "$MODE" in
        changeset_only)
            # Use LOC-based selection if map exists
            echo "Selection: Tests touching changed LOC" | tee -a "../../$LOG_FILE"
            if [ -f ".vitest-loc-map.json" ]; then
                local loc_tests=$(node scripts/select-tests-by-loc.js 2>/dev/null | grep -v "^#" | tr '\n' ' ')
                if [ -n "$loc_tests" ]; then
                    echo "Found tests for changed LOC: $loc_tests" | tee -a "../../$LOG_FILE"
                    vitest_args="$loc_tests"
                else
                    echo "No tests found for changed lines, falling back to --changed" | tee -a "../../$LOG_FILE"
                    vitest_args="--changed"
                fi
            else
                echo "LOC map not found, run with --full first to build" | tee -a "../../$LOG_FILE"
                vitest_args="--changed"
            fi
            ;;
        full)
            echo "Selection: All tests" | tee -a "../../$LOG_FILE"
            vitest_args=""
            ;;
        *)
            echo "Selection: Tests for changed files" | tee -a "../../$LOG_FILE"
            vitest_args="--changed"
            ;;
    esac
    
    # Run tests
    local output
    output=$(npm run test:run -- $vitest_args 2>&1) || true
    echo "$output" | tee -a "../../$LOG_FILE"
    
    # Parse results
    FRONTEND_PASSED=$(echo "$output" | grep -oP '\d+(?= passed)' | tail -1 || echo 0)
    FRONTEND_FAILED=$(echo "$output" | grep -oP '\d+(?= failed)' | tail -1 || echo 0)
    
    cd "$ROOT_DIR"
    
    local end=$(date +%s)
    FRONTEND_DURATION=$((end - start))
    echo "TIMING: Frontend=${FRONTEND_DURATION}s" >> "$LOG_FILE"
}

# ============================================
# E2E Tests (Playwright)
# ============================================
run_e2e_tests() {
    if [ "$INCLUDE_E2E" = false ]; then
        echo "" | tee -a "$LOG_FILE"
        echo -e "${YELLOW}Skipping E2E tests (use --e2e to include)${NC}" | tee -a "$LOG_FILE"
        return
    fi
    
    echo "" | tee -a "$LOG_FILE"
    echo -e "${BLUE}=== E2E Tests (Playwright) ===${NC}" | tee -a "$LOG_FILE"
    local start=$(date +%s)
    
    uv run pytest -s tests/validation/test_e2e_wrapper.py 2>&1 | tee -a "$LOG_FILE"
    
    local end=$(date +%s)
    E2E_DURATION=$((end - start))
    echo "TIMING: E2E=${E2E_DURATION}s" >> "$LOG_FILE"
}

# ============================================
# Summary
# ============================================
print_summary() {
    local total_end=$(date +%s)
    local total_duration=$((total_end - TOTAL_START))
    
    echo "" | tee -a "$LOG_FILE"
    echo -e "${BLUE}=== SMART VALIDATION SUMMARY ===${NC}" | tee -a "$LOG_FILE"
    echo "" | tee -a "$LOG_FILE"
    
    # Mode
    local mode_desc
    case "$MODE" in
        changeset_only) mode_desc="changeset_only (LOC-level)" ;;
        full) mode_desc="full (all tests)" ;;
        *) mode_desc="default (file-level)" ;;
    esac
    echo "Mode:        $mode_desc" | tee -a "$LOG_FILE"
    
    # Results
    local backend_status="${GREEN}✓${NC}"
    if [ "${BACKEND_FAILED:-0}" -gt 0 ]; then backend_status="${RED}✗${NC}"; fi
    
    local frontend_status="${GREEN}✓${NC}"
    if [ "${FRONTEND_FAILED:-0}" -gt 0 ]; then frontend_status="${RED}✗${NC}"; fi
    
    echo -e "Backend:     $backend_status ${BACKEND_PASSED:-0} passed, ${BACKEND_SKIPPED:-0} skipped, ${BACKEND_DESELECTED:-0} deselected (${BACKEND_DURATION}s)" | tee -a "$LOG_FILE"
    echo -e "Frontend:    $frontend_status ${FRONTEND_PASSED:-0} passed (${FRONTEND_DURATION}s)" | tee -a "$LOG_FILE"
    
    if [ "$INCLUDE_E2E" = true ]; then
        echo "E2E:         included (${E2E_DURATION}s)" | tee -a "$LOG_FILE"
    else
        echo "E2E:         skipped" | tee -a "$LOG_FILE"
    fi
    
    echo "" | tee -a "$LOG_FILE"
    echo "Total Time:  ${total_duration}s" | tee -a "$LOG_FILE"
    
    # Overall status
    local overall_failed=$((${BACKEND_FAILED:-0} + ${FRONTEND_FAILED:-0}))
    if [ "$overall_failed" -eq 0 ]; then
        echo -e "Status:      ${GREEN}✓ PASS${NC}" | tee -a "$LOG_FILE"
        return 0
    else
        echo -e "Status:      ${RED}✗ FAIL${NC}" | tee -a "$LOG_FILE"
        return 1
    fi
}

# ============================================
# Main
# ============================================
refresh_testmon_if_needed
run_backend_tests
run_frontend_tests
run_e2e_tests
print_summary

exit $?
